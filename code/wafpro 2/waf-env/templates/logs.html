<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Logs - WAF Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      background-size: 400% 400%;
      animation: bgMotion 20s ease infinite;
      color: #e2e8f0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    @keyframes bgMotion {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .fade-in {
      animation: fadeIn 1.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    td.truncate {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width: 768px) {
      table {
        font-size: 0.8rem;
      }
      td.truncate {
        max-width: 120px;
      }
    }
    th.cursor-pointer {
      cursor: pointer;
    }
  </style>
</head>
<body class="p-6 flex flex-col items-center min-h-screen">
  <div class="bg-slate-900 shadow-2xl rounded-2xl w-full max-w-7xl p-10 fade-in">
    <h1 class="text-4xl font-bold text-center text-teal-400 mb-10">
      <i class="fas fa-database animate-pulse"></i> WAF Logs Overview
    </h1>

    <!-- Search Box -->
    <div class="mb-6 max-w-xl mx-auto">
      <input
        type="text"
        id="searchInput"
        placeholder="🔍 Search any field..."
        class="w-full px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 text-gray-900"
      />
    </div>

    <!-- Table Section -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-slate-800 text-sm rounded-xl overflow-hidden" id="logsTable">
        <thead class="bg-slate-700 text-cyan-200 uppercase text-xs">
          <tr>
            <th class="px-6 py-3 cursor-pointer" data-sort="timestamp">Timestamp ▲▼</th>
            <th class="px-6 py-3 cursor-pointer" data-sort="ip">IP Address ▲▼</th>
            <th class="px-6 py-3 cursor-pointer" data-sort="user_agent">User-Agent ▲▼</th>
            <th class="px-6 py-3 cursor-pointer" data-sort="data">Input ▲▼</th>
            <th class="px-6 py-3 cursor-pointer" data-sort="status">Status ▲▼</th>
            <th class="px-6 py-3 cursor-pointer" data-sort="pattern">Pattern ▲▼</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-700">
          {% for log in logs %}
          <tr class="hover:bg-slate-700 transition cursor-pointer">
            <td class="px-6 py-4">{{ log.timestamp }}</td>
            <td class="px-6 py-4">{{ log.ip }}</td>
            <td class="px-6 py-4 truncate" title="{{ log.user_agent }}">{{ log.user_agent }}</td>
            <td class="px-6 py-4 truncate" title="{{ log.data }}">{{ log.data }}</td>
            <td class="px-6 py-4 font-semibold {% if log.status == 'danger' %}text-red-500{% else %}text-green-400{% endif %}">
              {{ 'threat' if log.status == 'danger' else 'Safe' }}
            </td>
            <td class="px-6 py-4 italic">{{ log.pattern if log.status == 'danger' else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Navigation Buttons -->
    <div class="mt-10 flex justify-between w-full">
      <a href="/" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded-lg transition-all duration-300">
        <i class="fas fa-home mr-2"></i>Back to Home
      </a>
      <form method="POST" action="/clear-logs" onsubmit="return confirm('Delete all logs?');">
        <button type="submit" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg transition-all duration-300">
          <i class="fas fa-trash mr-2"></i>Clear Logs
        </button>
      </form>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById("searchInput");
    const table = document.getElementById("logsTable");
    const tbody = table.querySelector("tbody");
    let rows = Array.from(tbody.querySelectorAll("tr"));
    let currentSort = { column: null, order: 'asc' };

    // البحث الحي
    searchInput.addEventListener("keyup", () => {
      const term = searchInput.value.toLowerCase();
      rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
      });
    });

    // فرز الأعمدة عند الضغط على رأس العمود
    table.querySelectorAll("thead th").forEach(header => {
      header.addEventListener("click", () => {
        const key = header.getAttribute("data-sort");
        if (!key) return;

        // نحدد الترتيب الجديد
        if (currentSort.column === key) {
          currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort.column = key;
          currentSort.order = 'asc';
        }

        rows.sort((a, b) => {
          let cellA = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.toLowerCase();
          let cellB = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).innerText.toLowerCase();

          // لو العمود هو timestamp نحول للتاريخ للمقارنة الصحيحة
          if (key === 'timestamp') {
            cellA = new Date(cellA);
            cellB = new Date(cellB);
          }

          if (cellA < cellB) return currentSort.order === 'asc' ? -1 : 1;
          if (cellA > cellB) return currentSort.order === 'asc' ? 1 : -1;
          return 0;
        });

        // إعادة عرض الصفوف بعد الفرز
        rows.forEach(row => tbody.appendChild(row));
      });
    });
  </script>
</body>
</html>
